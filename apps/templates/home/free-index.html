{% extends 'layouts/base.html' %}

{% block title %} Dashboard {% endblock title %}

<!-- Specific CSS goes HERE -->
{% block stylesheets %}{% endblock stylesheets %}

{% block content %}
---Free Plan----
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>

  function updateQuarterly() {
    var xhttp = new XMLHttpRequest();
    
    xhttp.onreadystatechange = function () {
      if (this.readyState == 4 && this.status == 200) {
        obj = JSON.parse(this.responseText);
        window.BarsChart.data.labels = Object.values(obj.Date);
        window.BarsChart.data.datasets[0].data = Object.values(obj.NN);
        window.BarsChart.data.datasets[1].data = Object.values(obj.NP);

        window.BarsChart.update();
      }
    };
    xhttp.open("GET", "http://127.0.0.1:9000/getQuarterlySetniment", true);
    xhttp.send();
  }


  function updateMonthly() {
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function () {
      if (this.readyState == 4 && this.status == 200) {
        obj = JSON.parse(this.responseText);
        window.BarsChart.data.labels = Object.values(obj.Date);
        window.BarsChart.data.datasets[0].data = Object.values(obj.NN);
        window.BarsChart.data.datasets[1].data = Object.values(obj.NP);

        window.BarsChart.update();
      }
    };
    xhttp.open("GET", "http://localhost:9000/getMonthlySetniment", true);
    xhttp.send();
  }


    function getTickerNews() {
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function () {
      if (this.readyState == 4 && this.status == 200) {
        obj = JSON.parse(this.responseText);
        let keys = Object.keys(obj);
        for(let k of keys){
          let innerValues = [];
          let innerKeys = Object.keys(obj[k]);
          for(let i of innerKeys){
            innerValues.push(obj[k][i]);

          }

          obj[k] = innerValues;

        }
        tableCreate(obj);
      }
    };
    xhttp.open("GET", "http://127.0.0.1:9000/ticker/getNews/1", true);
    xhttp.send();
  }

  getTickerNews();


function tableCreate(data) {
  console.log(data)
  data.Unnamed = data['Unnamed: 0'];
  delete data['Unnamed: 0'];
  for(let i = 0; i< 10 && data.Unnamed.length > i; i++){
    let rowHTML = document.getElementById('exampleRow').innerHTML;
    rowHTML = rowHTML.replace('--ID--', data.Unnamed[i]);
    rowHTML = rowHTML.replace('--TITLE--', data.title[i]);
    rowHTML = rowHTML.replace('--LINK--', data.url[i]);
    rowHTML = rowHTML.replace('--DATE--', data.date[i]);
    rowHTML = rowHTML.replace('--STATUS--', data.positve[i]+ data.negativ[i] );
    document.getElementById('newsBody').innerHTML += ('<tr>' + rowHTML + '</tr>');
  }

}



// tableCreate();




</script>
<!-- Header -->
<div class="header bg-primary pb-6">
  <div class="container-fluid">
    <div class="header-body">
      <!-- Card stats -->
      <div class="row">
        <div class="col-xl-3 col-md-6">
          <div class="card card-stats">
            <!-- Card body -->
            <div class="card-body">
              <div class="row">
                <div class="col">
                  <h5 class="card-title text-uppercase text-muted mb-0">Apple</h5>
                  <span class="h2 font-weight-bold mb-0">141.56$</span>
                </div>
              </div>
              <p class="mt-3 mb-0 text-sm">
                <span class="text-danger mr-2"><i class="fa fa-arrow-down"></i> 2%</span>
                <span class="text-nowrap"></span>
              </p>
            </div>
          </div>
        </div>
        <div class="col-xl-3 col-md-6">
          <div class="card card-stats">
            <!-- Card body -->
            <div class="card-body">
              <div class="row">
                <div class="col">
                  <h5 class="card-title text-uppercase text-muted mb-0">Google</h5>
                  <span class="h2 font-weight-bold mb-0">2,265.26$</span>
                </div>
              </div>
              <p class="mt-3 mb-0 text-sm">
                <span class="text-success mr-2"><i class="fa fa-arrow-up"></i> 4.16%</span>
                <span class="text-nowrap"></span>
              </p>
            </div>
          </div>
        </div>
        <div class="col-xl-3 col-md-6">
          <div class="card card-stats">
            <!-- Card body -->
            <div class="card-body">
              <div class="row">
                <div class="col">
                  <h5 class="card-title text-uppercase text-muted mb-0">Microsoft</h5>
                  <span class="h2 font-weight-bold mb-0">262$</span>
                </div>
              </div>
              <p class="mt-3 mb-0 text-sm">
                <span class="text-danger mr-2"><i class="fa fa-arrow-down"></i> 1%</span>
                <span class="text-nowrap"></span>
              </p>
            </div>
          </div>
        </div>
        <div class="col-xl-3 col-md-6">
          <div class="card card-stats">
            <!-- Card body -->
            <div class="card-body">
              <div class="row">
                <div class="col">
                  <h5 class="card-title text-uppercase text-muted mb-0">Amazon</h5>
                  <span class="h2 font-weight-bold mb-0">113.50$</span>
                </div>
              </div>
              <p class="mt-3 mb-0 text-sm">
                <span class="text-success mr-2"><i class="fa fa-arrow-up"></i> 3.48%</span>
                <span class="text-nowrap"></span>
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Page content -->
<div class="container-fluid mt--6">
  <div class="row">
    <div class="col-xl-8">
      <div class="card ">

        <div class="card-body">
          <!-- Chart -->


          <div>
            <canvas id="line-chart" width="800" height="450"></canvas>
          </div>
          <script>
            var ctx = document.getElementById("line-chart").getContext("2d");

            window.myLine = new Chart(ctx, {
              type: "bar",
              data: {
                labels: ["2020/02/17", "", "2020/02/23", "", "2020/02/29", ""],
                datasets: [
                  {
                    type: "bar",
                    backgroundColor: "rgba(255, 0, 0, 1)",
                    borderColor: "rgba(255, 0, 0, 1)",
                    borderWidth: 1,
                    barPercentage: 1,
                    label: "Negative News",
                    data: [60, 49, 72, 90, null, null]
                  },

                  {
                    type: "bar",
                    backgroundColor: "rgba(0, 0, 255, 1)",
                    borderColor: "rgba(0, 0, 255, 1)",
                    borderWidth: 0,
                    barPercentage: 0.9,
                    label: "Positive",
                    data: [10, 60, 2, 0, null, null]
                  },
                  {
                    type: "line",
                    label: "Close",
                    backgroundColor: "rgba(0, 255, 0, 1)",
                    borderColor: "rgba(0, 255, 0, 0.5)",
                    data: [25, 13, 30, 35],
                    lineTension: 0,
                    fill: false
                  },
                  {
                    type: "line",
                    label: "expected Close",
                    backgroundColor: "rgba(128,0,128, 1)",
                    borderColor: "rgba(128,0,128, 0.5)",
                    data: [null, null, null, 35, 20, 33],
                    lineTension: 0,
                    fill: false
                  }
                ]
              },
              
            });


          </script>
        </div>
      </div>
    </div>
    <div class="col-xl-4">
      <div class="card">
        <div class="card-header bg-transparent">
          <div class="row align-items-center">
            <div class="col">
              <h6 class="text-uppercase text-muted ls-1 mb-1"></h6>
              <h5 class="h3 mb-0">News Sentiment Analysis</h5>
            </div>
          </div>
        </div>
        <div class="card-body">
          <!-- Chart -->
          <div class="chart">
            <canvas id="chart-bars" class="chart-canvas"></canvas>
          </div>
        </div>
        <div>


          <div class="row">
            <div class="col-sm-12 text-right">
              <button onclick="updateMonthly()" class=" btn ">Monthly</button>
              <button onclick="updateQuarterly()" class=" btn ">Quarterly</button>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col-xl-12">
      <div class="card">
        <div class="card-header border-0">
          <div class="row align-items-center">
            <div class="col">
              <h3 class="mb-0">News</h3>
            </div>
            <div class="col text-right">
              <a href="#!" class="btn btn-sm btn-primary">See all</a>
            </div>
          </div>
        </div>
        <div class="table-responsive">
          <!-- Projects table -->
          <div id="news-table">
            <table width="100%" border="1">
              <thead>
                <tr>
                  <th>ID.</th>
                  <th>Title</th>
                  <th>Date</th>
                  <th>Link</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="newsBody">
                <tr id="exampleRow" style="display: none;">
                  <td>
                    --ID--
                  </td>
                  <td>
                    --TITLE--
                  </td>
                  <td>
                    --DATE--
                  </td>
                  <td>
                    --LINK--
                  </td>
                  <td>
                    --STATUS--
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
               
        </div>
      </div>
    </div>

  </div>

  {% include "includes/footer.html" %}

</div>

{% endblock content %}


<!-- Specific JS goes HERE -->
{% block javascripts %}


<script src="/static/assets/vendor/chart.js/dist/Chart.min.js"></script>
<script src="/static/assets/vendor/chart.js/dist/Chart.extension.js"></script>
<script>
  	var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function () {
      if (this.readyState == 4 && this.status == 200) {
        obj = JSON.parse(this.responseText);
        window.BarsChart.data.labels = (Object.values(obj.Date)).slice(-7);
        window.BarsChart.data.datasets[0].data = (Object.values(obj.NN)).slice(-7);
        window.BarsChart.data.datasets[1].data = (Object.values(obj.NP)).slice(-7);

        window.BarsChart.update();
      }
    };
    xhttp.open("GET", "http://localhost:5000/getMonthlySetniment", true);
    xhttp.send();


    ////////////////////////////////////////////////

    var xhttp2 = new XMLHttpRequest();

    xhttp2.onreadystatechange = function () {
      if (this.readyState == 4 && this.status == 200) {
        obj = JSON.parse(this.responseText);
        window.myLine.data.labels = ((Object.values(obj.Date)).slice(-1100, -990));
        
        window.myLine.data.datasets[0].data = ((Object.values(obj.NN)).slice(-1100, -1000));
        window.myLine.data.datasets[1].data = ((Object.values(obj.NP)).slice(-1100, -1000));
        window.myLine.data.datasets[2].data = (Object.values(obj.close)).slice(-1100, -1000);
        // window.myLine.data.datasets[1].data = []
        window.myLine.data.datasets[0].data.push(null,null,null,null,null,null,null,null,null,null)
        window.myLine.data.datasets[1].data.push(null,null,null,null,null,null,null,null,null,null)
        window.myLine.data.datasets[2].data.push(null,null,null,null,null,null,null,null,null,null)
        window.myLine.data.datasets[3].data = (new Array(100).fill(null)).concat((Object.values(obj.EC)).slice(-1000, -990));
        window.myLine.update();
      }
    };
    xhttp2.open("GET", "http://localhost:5000/getAppleData", true);
    xhttp2.send();
</script>
{% endblock javascripts %}